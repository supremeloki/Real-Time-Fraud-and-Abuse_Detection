name: CI Quality Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.8'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black flake8 mypy pyyaml

      # ----------------------
      # Black auto-format
      # ----------------------
      - name: Run Black formatter (auto-fix)
        run: |
          black src tests
          git diff --exit-code || echo "Black reformatted files â€” please commit the formatted version."

      # ----------------------
      # Flake8 linter
      # ----------------------
      - name: Run Flake8 linter
        run: flake8 src tests --max-line-length=88

      # ----------------------
      # MyPy type checking
      # ----------------------
      - name: Run MyPy type checking
        run: mypy src tests --ignore-missing-imports || echo "MyPy warnings present but not blocking CI"

      # ----------------------
      # Pytest (optional)
      # ----------------------
      - name: Run Pytest
        run: |
          if [ -d "tests" ]; then
              pytest tests
          else
              echo "No tests directory - skipping pytest"
          fi

      # ----------------------
      # YAML syntax check
      # ----------------------
      - name: Check YAML syntax
        run: |
          python -c "
          import yaml, os
          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if not d.startswith('.') and d not in ['.git','__pycache__']]
              for file in files:
                  if file.endswith(('.yaml','.yml')):
                      try:
                          with open(os.path.join(root,file),'r') as f:
                              yaml.safe_load_all(f)
                      except yaml.YAMLError as e:
                          print(f'YAML error in {os.path.join(root,file)}: {e}')
                          exit(1)
          print('All YAML files are valid.')
          "

      # ----------------------
      # JSON syntax check
      # ----------------------
      - name: Check JSON syntax
        run: |
          python -c "
          import json, os
          for root, dirs, files in os.walk('.'):
              dirs[:] = [d for d in dirs if not d.startswith('.') and d not in ['.git','__pycache__']]
              for file in files:
                  if file.endswith('.json'):
                      try:
                          with open(os.path.join(root,file),'r') as f:
                              json.load(f)
                      except json.JSONDecodeError as e:
                          print(f'JSON error in {os.path.join(root,file)}: {e}')
                          exit(1)
          print('All JSON files are valid.')
          "

      # ----------------------
      # Python syntax check
      # ----------------------
      - name: Validate Python syntax
        run: |
          python -c "
          import ast, os
          errors=[]
          for root, dirs, files in os.walk('src'):
              for file in files:
                  if file.endswith('.py'):
                      try:
                          with open(os.path.join(root,file),'r') as f:
                              ast.parse(f.read())
                      except SyntaxError as e:
                          errors.append(f'Syntax error in {os.path.join(root,file)}: {e}')
          if errors:
              for error in errors:
                  print(error)
              exit(1)
          print('All Python files have valid syntax.')
          "