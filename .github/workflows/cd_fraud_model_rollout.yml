name: CD Fraud Model Rollout

on:
  push:
    branches:
      - main

jobs:
  deploy-model:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install MLflow Client
      run: pip install mlflow

    - name: Get Latest MLflow Run ID
      id: get_run_id
      run: |
        RUN_ID=$(mlflow runs list --experiment-name "fraud_detection" --limit 1 --order-by "start_time DESC" | awk 'NR==2 {print $1}')
        if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "" ]; then
          echo "No runs found in fraud_detection experiment. Skipping deployment."
          echo "run_id=skip" >> $GITHUB_OUTPUT
        else
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
        fi

    - name: Download Latest Production Model
      if: ${{ secrets.MLFLOW_PROD_MODEL_RUN_ID != '' }}
      run: |
        mlflow artifacts download --run-id "${{ secrets.MLFLOW_PROD_MODEL_RUN_ID }}" --artifact-path model --dst-path ./model_artifacts
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Log in to Docker Hub
      if: steps.get_run_id.outputs.run_id != 'skip'
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Build and Push Docker Image
      if: steps.get_run_id.outputs.run_id != 'skip'
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./deployment_ops/docker/Dockerfile.inference_service
        push: true
        tags: snapptech/fraud-inference:${{ github.sha }}

    - name: Configure Kubernetes Context
      if: steps.get_run_id.outputs.run_id != 'skip'
      uses: azure/k8s-set-context@v2
      with:
        kubeconfig: ${{ secrets.KUBECONFIG_PROD }}

    - name: Deploy to Kubernetes
      if: steps.get_run_id.outputs.run_id != 'skip'
      run: |
        kubectl apply -f deployment_ops/kubernetes/k8s_fraud_deployment.yaml
        kubectl set image deployment/fraud-inference-service fraud-inference=snapptech/fraud-inference:${{ github.sha }}
        kubectl rollout status deployment/fraud-inference-service --timeout=300s
      continue-on-error: false